import songs from "./Songs.js"; // Supondo que 'Songs.js' cont√©m informa√ß√µes das m√∫sicas, incluindo o ID.

// Fun√ß√£o para obter o ID √∫nico da m√∫sica atual
function getMusicId() {
    return songs[index].id;  // Pegando o ID da m√∫sica com base no √≠ndice atual
}
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

const db = getDatabase();


// Selecionando elementos do player
const player = document.querySelector("#player");
const musicName = document.querySelector("#musicName");
const playPauseButton = document.querySelector("#playPauseButton");
const prevButton = document.querySelector("#prevButton");
const nextButton = document.querySelector("#nextButton");
const currentTime = document.querySelector("#currentTime");
const duration = document.querySelector("#duration");
const progressBar = document.querySelector(".progress-bar");
const progress = document.querySelector(".progress");
const musicCover = document.querySelector("#musicCover");
const textButtonPlay = "<i class='bx bx-caret-right'></i>";
const textButtonPause = "<i class='bx bx-pause'></i>";

let index = 0;




// Fun√ß√£o para carregar uma m√∫sica
const loadMusic = (index) => {
    player.src = songs[index].src;
    musicName.innerHTML = songs[index].name;
    musicCover.src = songs[index].cover;
    player.load();
    displayComments();  // Carrega os coment√°rios da m√∫sica atual
};


// Fun√ß√£o Play/Pause
const playPause = () => {
    if (player.paused) {
        player.play().then(() => {
            playPauseButton.innerHTML = textButtonPause;
        }).catch(error => console.error("Erro ao tentar dar play:", error));
    } else {
        player.pause();
        playPauseButton.innerHTML = textButtonPlay;
    }
};


player.ontimeupdate = () => updateTime();

const updateTime = () => {
  const currentMinutes = Math.floor(player.currentTime / 60);
  const currentSeconds = Math.floor(player.currentTime % 60);
  currentTime.textContent = currentMinutes + ":" + formatZero(currentSeconds);

  const durationFormatted = isNaN(player.duration) ? 0 : player.duration;
  const durationMinutes = Math.floor(durationFormatted / 60);
  const durationSeconds = Math.floor(durationFormatted % 60);
  duration.textContent = durationMinutes + ":" + formatZero(durationSeconds);

  const progressWidth = durationFormatted
    ? (player.currentTime / durationFormatted) * 100
    : 0;

  progress.style.width = progressWidth + "%";
};





progressBar.onclick = (e) => {
  const newTime = (e.offsetX / progressBar.offsetWidth) * player.duration;
  player.currentTime = newTime;
};

// Fun√ß√£o para alternar entre m√∫sicas
const prevNextMusic = (type = "next") => {
    index = (type === "next") ? (index + 1) % songs.length : (index - 1 + songs.length) % songs.length;
    loadMusic(index);
    playPause(); // üî• Toca automaticamente
};

// Atualizar tempo e barra de progresso
player.ontimeupdate = () => {
    const currentMinutes = Math.floor(player.currentTime / 60);
    const currentSeconds = Math.floor(player.currentTime % 60);
    currentTime.textContent = currentMinutes + ":" + formatZero(currentSeconds);

    const durationFormatted = isNaN(player.duration) ? 0 : player.duration;
    const durationMinutes = Math.floor(durationFormatted / 60);
    const durationSeconds = Math.floor(durationFormatted % 60);
    duration.textContent = durationMinutes + ":" + formatZero(durationSeconds);

    const progressWidth = durationFormatted ? (player.currentTime / durationFormatted) * 100 : 0;
    progress.style.width = progressWidth + "%";
};
prevButton.onclick = () => {
    const currentTime = new Date().getTime(); // Hora do clique atual
    const timeDifference = currentTime - lastClickTime; // Diferen√ßa de tempo entre os cliques
    
    if (timeDifference < 500) {  // Se o tempo entre os cliques for menor que 500ms, √© considerado um clique duplo
        goToPreviousMusic(); // Vai para a m√∫sica anterior
    } else {
        restartMusic();  // Reinicia a m√∫sica
    }

    lastClickTime = currentTime; // Atualiza o tempo do √∫ltimo clique
};
const restartMusic = () => {
    player.currentTime = 0;  // Reinicia a m√∫sica
    player.play();  // Recome√ßa a m√∫sica
};
const goToPreviousMusic = () => {
    index = (index - 1 + songs.length) % songs.length;  // Vai para a m√∫sica anterior
    loadMusic(index);  // Carrega a m√∫sica anterior
    playPause();  // Toca a m√∫sica anterior
};

// Atualizar tempo quando clicar na barra de progresso
progressBar.onclick = (e) => {
    const newTime = (e.offsetX / progressBar.offsetWidth) * player.duration;
    player.currentTime = newTime;
};

// Formatar segundos para 00:00
const formatZero = (n) => (n < 10 ? "0" + n : n);

// Adicionando eventos aos bot√µes
playPauseButton.onclick = playPause;
prevButton.onclick = () => prevNextMusic("prev");
nextButton.onclick = () => prevNextMusic("next");

// Iniciar com a primeira m√∫sica
loadMusic(0);

function alterarImagemCapa(caminhoImagem) {
    const imagemCapa = document.getElementById("musicCover");
    imagemCapa.src = caminhoImagem;
  }
  
  const musica = {
    nome: "Nome da M√∫sica",
    arquivo: "caminho-da-musica.mp3",
    capa: "caminho-da-imagem-da-musica.jpg"
  };
  
  function carregarMusica(musica) {
    const player = document.getElementById("audioPlayer");
    player.src = musica.arquivo;
    alterarImagemCapa(musica.capa);
  }
  
  carregarMusica(musica);

  document.addEventListener("DOMContentLoaded", () => {
    const textComent = document.getElementById("inputText"); // Campo de texto
    const form = document.getElementById("formulario"); // Formul√°rio
    const commentPost = document.getElementById("commentPost"); // √Årea onde os coment√°rios aparecem
    const player = document.getElementById("player"); // Player de m√∫sica

    console.log("P√°gina carregada!"); // Verifica se o JS est√° rodando

   // Fun√ß√£o para obter um ID √∫nico para cada m√∫sica
function getMusicId() {
    return songs[index].id;  // Pegando o ID da m√∫sica com base no √≠ndice atual
}
// Fun√ß√£o para exibir os coment√°rios da m√∫sica
function displayComments() {
    const commentPost = document.getElementById("commentPost");  // √Årea onde os coment√°rios aparecem
    commentPost.innerHTML = "<h5>Coment√°rios</h5>";  // Mant√©m o t√≠tulo da se√ß√£o de coment√°rios

    const musicId = getMusicId(); // Obt√©m o ID da m√∫sica atual
    const commentsRef = ref(db, 'comentarios/' + musicId); // Refer√™ncia ao n√≥ de coment√°rios da m√∫sica no Firebase

    // Ouvindo mudan√ßas nos coment√°rios
    onValue(commentsRef, (snapshot) => {
        const comments = snapshot.val();
        if (comments) {
            Object.values(comments).forEach(comment => {
                addCommentToScreen(comment.text); // Exibe o coment√°rio na tela
            });
        } else {
            commentPost.innerHTML += "<p><em>Sem coment√°rios ainda...</em></p>";
        }
    });
}
// Fun√ß√£o para adicionar um coment√°rio na tela (sem precisar recarregar)
function addCommentToScreen(comment) {
    const commentPost = document.getElementById("commentPost");
    let p = document.createElement("p");
    p.classList.add("p-2", "text-wrap", "text-white");
    p.innerHTML = `<strong>${comment}</strong>`;
    commentPost.appendChild(p);
}
// Evento para adicionar coment√°rios
form.addEventListener("submit", (event) => {
    event.preventDefault();

    const musicId = getMusicId();  // Obt√©m o ID da m√∫sica atual
    const commentText = textComent.value.trim();

    if (commentText === "") {
        return; // Impede coment√°rios vazios
    }

    const commentsRef = ref(db, 'comentarios/' + musicId); // Refer√™ncia para o n√≥ de coment√°rios da m√∫sica

    // Salva o novo coment√°rio no Firebase
    const newCommentRef = push(commentsRef);
    set(newCommentRef, {
        text: commentText,
        timestamp: new Date().toISOString()
    }).then(() => {
        addCommentToScreen(commentText);  // Exibe o coment√°rio na tela
        textComent.value = "";  // Limpa o campo de texto
    }).catch((error) => {
        console.error("Erro ao salvar coment√°rio:", error);
    });
});


    
});
// Limpa coment√°rios antigos e carrega os novos
function carregarComentarios() {
    const commentPost = document.getElementById("commentPost");
    commentPost.innerHTML = "<h5>Coment√°rios</h5>";
  
    const musicId = getCurrentMusicId();
    const commentsRef = ref(db, 'comentarios/' + musicId);
  
    onValue(commentsRef, (snapshot) => {
      commentPost.innerHTML = "<h5>Coment√°rios</h5>"; // limpa de novo, s√≥ por seguran√ßa
      const comments = snapshot.val();
  
      if (comments) {
        Object.values(comments).forEach(comment => {
          const div = document.createElement("div");
          div.innerHTML = `
            <p>${comment.text}</p>
            <small>${new Date(comment.timestamp).toLocaleString('pt-BR')}</small>
            <hr>
          `;
          commentPost.appendChild(div);
        });
      } else {
        commentPost.innerHTML += "<p><em>Nenhum coment√°rio ainda.</em></p>";
      }
    });
  }
  document.getElementById("nextButton").addEventListener("click", () => {
  // trocar m√∫sica...
  tocarProximaMusica();
  carregarComentarios(); // <- aqui!
});